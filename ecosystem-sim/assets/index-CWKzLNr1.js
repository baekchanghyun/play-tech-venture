(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();var R=(n=>(n.HERBIVORE="HERBIVORE",n.PREDATOR="PREDATOR",n))(R||{});function Q(n){let e=n|0;function t(){e=e+1831565813|0;let l=Math.imul(e^e>>>15,1|e);return l=l+Math.imul(l^l>>>7,61|l)^l,((l^l>>>14)>>>0)/4294967296}function i(){return t()}function s(l,u){const d=u-l+1;return Math.floor(t()*d)+l}function o(){const l=t(),u=t(),d=l===0?Number.EPSILON:l;return Math.sqrt(-2*Math.log(d))*Math.cos(2*Math.PI*u)}function a(l){if(l.length===0)throw new Error("빈 배열에서 pick 불가");return l[Math.floor(t()*l.length)]}function r(l){for(let u=l.length-1;u>0;u--){const d=Math.floor(t()*(u+1)),h=l[u];l[u]=l[d],l[d]=h}return l}function c(){return e}return{next:t,nextInt:s,nextFloat:i,nextGaussian:o,pick:a,shuffle:r,state:c}}var y=(n=>(n.PLAIN="PLAIN",n.WATER="WATER",n.ROCK="ROCK",n))(y||{});function ue(n,e){const{width:t,height:i}=n;let s=n.waterRatio,o=n.rockRatio;if(s+o>.7){const h=.7/(s+o);s*=h,o*=h}const a=pe(t,i,e),r=[...a].sort((h,p)=>h-p),c=t*i,l=r[Math.floor(c*s)-1]??-1/0,u=r[Math.ceil(c*(1-o))]??1/0,d=[];for(let h=0;h<i;h++)for(let p=0;p<t;p++){const m=h*t+p,C=a[m];let g;C<=l?g=y.WATER:C>=u?g=y.ROCK:g=y.PLAIN;const H=g===y.PLAIN?fe(C,l,u):0;d.push({terrain:g,plantDensity:H})}return me(d,c,e),d}function pe(n,e,t){const i=new Array(n*e).fill(0),s=z(n,e,8,t),o=z(n,e,16,t);for(let a=0;a<n*e;a++)i[a]=s[a]+o[a]*.5;return i}function z(n,e,t,i){const s=t+2,o=t+2,a=[];for(let c=0;c<s*o;c++)a.push(i.next());const r=[];for(let c=0;c<e;c++)for(let l=0;l<n;l++){const u=l/n*t,d=c/e*t,h=Math.floor(u),p=Math.floor(d),m=h+1,C=p+1,g=u-h,H=d-p,oe=a[p*s+h],ae=a[p*s+m],re=a[C*s+h],le=a[C*s+m],N=Y(g),W=Y(H),ce=oe*(1-N)+ae*N,he=re*(1-N)+le*N,de=ce*(1-W)+he*W;r.push(de)}return r}function Y(n){return n*n*(3-2*n)}function fe(n,e,t){if(t<=e)return .5;const i=(n-e)/(t-e);return Math.max(0,Math.min(1,i))}function me(n,e,t){const i=Math.ceil(e*.3);let s=n.filter(a=>a.terrain===y.PLAIN).length;if(s>=i)return;const o=[];for(let a=0;a<n.length;a++)n[a].terrain!==y.PLAIN&&o.push(a);t.shuffle(o);for(const a of o){if(s>=i)break;n[a]={terrain:y.PLAIN,plantDensity:.5},s++}}function Z(n,e){const t=ue(n,e);return{config:n,tiles:t}}function V(n,e){const{width:t,height:i}=n.config;return e.x<0||e.x>=t||e.y<0||e.y>=i?null:n.tiles[e.y*t+e.x]}function O(n,e){const t=V(n,e);return t===null?!1:t.terrain===y.PLAIN}function Ee(n,e,t){const{width:i}=n.config,s=e.y*i+e.x,o=n.tiles[s];if(o.terrain!==y.PLAIN||o.plantDensity<=0)return 0;const a=Math.min(o.plantDensity,t);return o.plantDensity=Math.max(0,o.plantDensity-t),a}function Re(n,e){const{width:t,height:i}=n.config,{tiles:s}=n,o=s.map(a=>a.plantDensity);for(let a=0;a<i;a++)for(let r=0;r<t;r++){const c=a*t+r,l=s[c];if(l.terrain!==y.PLAIN)continue;const u=ye(o,s,t,i,r,a),h=(u.length>0?u.reduce((p,m)=>p+m,0)/u.length:0)>=.5?e*1.5:e;l.plantDensity=Math.min(1,l.plantDensity+h)}}function ye(n,e,t,i,s,o){const a=[[0,-1],[0,1],[-1,0],[1,0]],r=[];for(const[c,l]of a){const u=s+c,d=o+l;if(u<0||u>=t||d<0||d>=i)continue;const h=d*t+u;e[h].terrain===y.PLAIN&&r.push(n[h])}return r}function Ce(n){const{width:e,height:t}=n.config,i=[];for(let s=0;s<t;s++)for(let o=0;o<e;o++){const a=s*e+o;n.tiles[a].terrain===y.PLAIN&&i.push({x:o,y:s})}return i}const ge=.1,Se=2;function M(n){return Math.max(ge,Math.min(Se,n))}function be(n,e,t){const i=t.next(),s=t.next(),o=t.next();return{speed:n.speed*i+e.speed*(1-i),sight:n.sight*s+e.sight*(1-s),metabolism:n.metabolism*o+e.metabolism*(1-o)}}function ve(n,e,t){return{speed:M(n.speed+t.nextGaussian()*e),sight:M(n.sight+t.nextGaussian()*e),metabolism:M(n.metabolism+t.nextGaussian()*e)}}function xe(n,e,t,i){const s=be(n,e,i);return ve(s,t,i)}function F(n){return{speed:.8+n.next()*.4,sight:.8+n.next()*.4,metabolism:.8+n.next()*.4}}const D={N:{x:0,y:-1},NE:{x:1,y:-1},E:{x:1,y:0},SE:{x:1,y:1},S:{x:0,y:1},SW:{x:-1,y:1},W:{x:-1,y:0},NW:{x:-1,y:-1},NONE:{x:0,y:0}},E={HERBIVORE_MAX_ENERGY:100,HERBIVORE_INITIAL_ENERGY:60,HERBIVORE_BASE_METABOLISM:1.5,HERBIVORE_EAT_AMOUNT:.3,HERBIVORE_EAT_ENERGY:15,HERBIVORE_BREED_COST:40,HERBIVORE_BREED_THRESHOLD:.7,HERBIVORE_BREED_COOLDOWN:30,HERBIVORE_BASE_SIGHT:5,HERBIVORE_BASE_SPEED:1,PREDATOR_MAX_ENERGY:120,PREDATOR_INITIAL_ENERGY:80,PREDATOR_BASE_METABOLISM:1.5,PREDATOR_EAT_ENERGY:60,PREDATOR_BREED_COST:35,PREDATOR_BREED_THRESHOLD:.6,PREDATOR_BREED_COOLDOWN:30,PREDATOR_BASE_SIGHT:7,PREDATOR_BASE_SPEED:2,PREDATOR_HUNT_RANGE:2};function L(n,e){const t=n.type===R.HERBIVORE;return{id:e,type:n.type,pos:{...n.pos},genes:{...n.genes},energy:t?E.HERBIVORE_INITIAL_ENERGY:E.PREDATOR_INITIAL_ENERGY,maxEnergy:t?E.HERBIVORE_MAX_ENERGY:E.PREDATOR_MAX_ENERGY,age:0,generation:n.generation,childrenCount:0,breedCooldown:0,alive:!0}}function _e(n,e,t,i,s){if(!n.alive)return null;const o=Pe(n);if(n.energy-=o,n.energy<=0)return n.alive=!1,null;let a=null;return n.type===R.HERBIVORE?a=Ie(n,e,t,i,s):a=Ne(n,e,t,i,s),n.age+=1,n.breedCooldown=Math.max(0,n.breedCooldown-1),a}function Pe(n){return(n.type===R.HERBIVORE?E.HERBIVORE_BASE_METABOLISM:E.PREDATOR_BASE_METABOLISM)*n.genes.metabolism*(1+n.genes.speed*.5)*(1+n.genes.sight*.3)}function Ie(n,e,t,i,s){const o=E,a=o.HERBIVORE_BASE_SIGHT*n.genes.sight,r=ee(n,t,a),c=r.filter(d=>d.type===R.PREDATOR);if(c.length>0){const d=v(n.pos,c);if(d&&_(n.pos,d.pos)<=a*.6){const p=Te(n.pos,d.pos);return G(n,e,p,s),T(n,e),null}}const l=n.energy/n.maxEnergy;let u=null;if(l<.3){const d=$(n.pos,e,a);d?b(n,e,d,s):x(n,e,s),T(n,e)}else if(l>=o.HERBIVORE_BREED_THRESHOLD&&n.breedCooldown===0){const d=r.filter(p=>p.type===R.HERBIVORE&&p.id!==n.id&&p.alive),h=v(n.pos,d);h&&_(n.pos,h.pos)<=1.5?u=ne(n,h,e,i,s):h?b(n,e,h.pos,s):x(n,e,s),T(n,e)}else{const d=$(n.pos,e,a);d?b(n,e,d,s):x(n,e,s),T(n,e)}return u}function Ne(n,e,t,i,s){const o=E,a=o.PREDATOR_BASE_SIGHT*n.genes.sight,r=ee(n,t,a),c=r.filter(h=>h.type===R.HERBIVORE&&h.alive),l=n.energy/n.maxEnergy;let u=null;const d=A(n,t);if(l<.3){if(!d){const h=v(n.pos,c);h?(b(n,e,h.pos,s),A(n,t)):x(n,e,s)}}else if(l>=o.PREDATOR_BREED_THRESHOLD&&n.breedCooldown===0){const h=r.filter(m=>m.type===R.PREDATOR&&m.id!==n.id&&m.alive),p=v(n.pos,h);if(p&&_(n.pos,p.pos)<=1.5)u=ne(n,p,e,i,s);else if(p)b(n,e,p.pos,s);else if(!d){const m=v(n.pos,c);m?(b(n,e,m.pos,s),A(n,t)):x(n,e,s)}}else if(!d){const h=v(n.pos,c);h?(b(n,e,h.pos,s),A(n,t)):x(n,e,s)}return u}function ee(n,e,t){return e.filter(i=>i.id!==n.id&&i.alive&&_(n.pos,i.pos)<=t)}function _(n,e){return Math.abs(n.x-e.x)+Math.abs(n.y-e.y)}function v(n,e){if(e.length===0)return null;let t=null,i=1/0;for(const s of e){const o=_(n,s.pos);o<i&&(i=o,t=s)}return t}function $(n,e,t){const i=Math.ceil(t);let s=null,o=-1;for(let a=-i;a<=i;a++)for(let r=-i;r<=i;r++){if(Math.abs(r)+Math.abs(a)>t)continue;const c={x:n.x+r,y:n.y+a},l=V(e,c);if(l&&l.plantDensity>.2){const u=Math.max(1,Math.abs(r)+Math.abs(a)),d=l.plantDensity/u;d>o&&(o=d,s=c)}}return s}function b(n,e,t,i){const s=t.x-n.pos.x,o=t.y-n.pos.y,a=te(s,o);G(n,e,a,i)}function Te(n,e){const t=n.x-e.x,i=n.y-e.y;return te(t,i)}function te(n,e){if(n===0&&e===0)return"NONE";const t=Math.abs(n),i=Math.abs(e);return i>t*2?e<0?"N":"S":t>i*2?n<0?"W":"E":n>0&&e<0?"NE":n>0&&e>0?"SE":n<0&&e<0?"NW":"SW"}function G(n,e,t,i){if(t==="NONE")return;const s=n.type===R.HERBIVORE?E.HERBIVORE_BASE_SPEED:E.PREDATOR_BASE_SPEED,o=Math.max(1,Math.floor(s*n.genes.speed)),a=D[t];for(let r=0;r<o;r++){const c={x:n.pos.x+a.x,y:n.pos.y+a.y};if(O(e,c))n.pos=c;else{const l=Ae(n.pos,t,e,i);if(l!=="NONE"){const u=D[l],d={x:n.pos.x+u.x,y:n.pos.y+u.y};O(e,d)&&(n.pos=d)}break}}}function Ae(n,e,t,i){const s=["N","NE","E","SE","S","SW","W","NW"],o=s.indexOf(e);if(o===-1)return"NONE";const a=[s[(o+1)%8],s[(o+7)%8],s[(o+2)%8],s[(o+6)%8]];i.shuffle(a);for(const r of a){const c=D[r],l={x:n.x+c.x,y:n.y+c.y};if(O(t,l))return r}return"NONE"}function x(n,e,t){const i=["N","NE","E","SE","S","SW","W","NW"],s=t.pick(i);G(n,e,s,t)}function T(n,e){const t=V(e,n.pos);if(!t||t.plantDensity<=0)return;const i=Ee(e,n.pos,E.HERBIVORE_EAT_AMOUNT);if(i>0){const s=i/E.HERBIVORE_EAT_AMOUNT*E.HERBIVORE_EAT_ENERGY*n.genes.metabolism;n.energy=Math.min(n.maxEnergy,n.energy+s)}}function A(n,e){const t=E.PREDATOR_HUNT_RANGE;let i=null,s=1/0;for(const o of e){if(o.type!==R.HERBIVORE||!o.alive||o.id===n.id)continue;const a=_(n.pos,o.pos);a<=t&&a<s&&(s=a,i=o)}if(i){i.alive=!1;const o=E.PREDATOR_EAT_ENERGY*n.genes.metabolism;return n.energy=Math.min(n.maxEnergy,n.energy+o),!0}return!1}function ne(n,e,t,i,s){const o=n.type===R.HERBIVORE,a=o?E.HERBIVORE_BREED_COST:E.PREDATOR_BREED_COST,r=o?E.HERBIVORE_BREED_COOLDOWN:E.PREDATOR_BREED_COOLDOWN;if(n.energy<a||e.energy<a*.5)return null;const c=we(n.pos,t,s);if(!c)return null;const l=xe(n.genes,e.genes,i.mutationRate,s);n.energy-=a,e.energy-=a*.5,n.breedCooldown=r,e.breedCooldown=r,n.childrenCount+=1,e.childrenCount+=1;const u={type:n.type,pos:c,genes:l,generation:Math.max(n.generation,e.generation)+1};return L(u,-1)}function we(n,e,t){const i=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],s=t.shuffle([...i]);for(const[o,a]of s){const r={x:n.x+o,y:n.y+a};if(O(e,r))return r}return null}function Oe(n){const e=Q(n.seed),t=Z(n.world,e),i=Ce(t),s=e.shuffle([...i]),o=[];let a=1;const r=Math.min(n.initialHerbivores,s.length);for(let h=0;h<r;h++){const p=L({type:R.HERBIVORE,pos:s[h],genes:F(e),generation:0},a++);o.push(p)}const c=r,l=Math.min(n.initialPredators,s.length-c);for(let h=0;h<l;h++){const p=L({type:R.PREDATOR,pos:s[c+h],genes:F(e),generation:0},a++);o.push(p)}const u={config:n,world:t,agents:o,tick:0,nextEntityId:a,history:[],running:!1,speed:1},d=ie(u);return u.history.push(d),{state:u,prng:e}}function X(n,e){const t=Array.from({length:n.agents.length},(o,a)=>a);e.shuffle(t);const i=[];for(const o of t){const a=n.agents[o];if(!a.alive)continue;const r=_e(a,n.world,n.agents,n.config,e);r&&(r.id=n.nextEntityId++,i.push(r))}n.agents=n.agents.filter(o=>o.alive);for(const o of i)n.agents.push(o);Re(n.world,n.config.plantRegrowthRate),n.tick+=1;const s=ie(n);n.history.push(s),n.history.length>500&&(n.history=n.history.slice(n.history.length-500))}function ie(n){let e=0;for(const a of n.world.tiles)e+=a.plantDensity;const t=[],i=[];for(const a of n.agents)a.alive&&(a.type===R.HERBIVORE?t.push(a):i.push(a));const s=U(t),o=U(i);return{tick:n.tick,totalPlant:e,herbivoreCount:t.length,predatorCount:i.length,avgHerbivoreGenes:s,avgPredatorGenes:o}}function U(n){if(n.length===0)return{speed:0,sight:0,metabolism:0};let e=0,t=0,i=0;for(const o of n)e+=o.genes.speed,t+=o.genes.sight,i+=o.genes.metabolism;const s=n.length;return{speed:e/s,sight:t/s,metabolism:i/s}}function P(n){let e=0;for(let t=0;t<n.length;t++){const i=n.charCodeAt(t);e=(e<<5)-e+i,e|=0}return e}const k=[{name:"Balanced",description:"균형 잡힌 기본 생태계",config:{world:{width:60,height:40,waterRatio:.15,rockRatio:.1},initialHerbivores:40,initialPredators:10,plantRegrowthRate:.01,mutationRate:.1,seed:P("balanced")}},{name:"Overpopulation",description:"초식동물 과잉 — 자원 고갈 관찰",config:{world:{width:60,height:40,waterRatio:.15,rockRatio:.1},initialHerbivores:100,initialPredators:5,plantRegrowthRate:.005,mutationRate:.1,seed:P("overpopulation")}},{name:"Predator Doom",description:"포식자 과다 — 멸종 위기 시나리오",config:{world:{width:60,height:40,waterRatio:.15,rockRatio:.1},initialHerbivores:30,initialPredators:25,plantRegrowthRate:.01,mutationRate:.1,seed:P("predator-doom")}},{name:"Island",description:"작은 섬 — 제한된 공간에서의 생존",config:{world:{width:30,height:30,waterRatio:.35,rockRatio:.05},initialHerbivores:20,initialPredators:5,plantRegrowthRate:.01,mutationRate:.1,seed:P("island")}},{name:"Evolution Lab",description:"높은 돌연변이 — 급격한 진화 관찰",config:{world:{width:60,height:40,waterRatio:.15,rockRatio:.1},initialHerbivores:60,initialPredators:15,plantRegrowthRate:.01,mutationRate:.3,seed:P("evolution-lab")}}],f={BG_DARK:"#0f0f1a",BG_PANEL:"#1a1a2e",TERRAIN_PLAIN:"#2d5016",TERRAIN_PLAIN_LUSH:"#4a8c1c",TERRAIN_WATER:"#1a3a5c",TERRAIN_ROCK:"#4a4a4a",HERBIVORE:"#4fc3f7",HERBIVORE_LOW:"#ff8a65",PREDATOR:"#ef5350",PREDATOR_LOW:"#8d6e63",TEXT_SECONDARY:"#9e9e9e",ACCENT:"#64ffda",GRID_LINE:"rgba(255, 255, 255, 0.05)",CHART_PLANT:"#66bb6a",CHART_HERBIVORE:"#4fc3f7",CHART_PREDATOR:"#ef5350",CHART_SPEED:"#ffca28",CHART_SIGHT:"#ab47bc",CHART_METABOLISM:"#26c6da"};function He(n,e,t){const i=m=>{const C=parseInt(m.slice(1),16);return[C>>16&255,C>>8&255,C&255]},[s,o,a]=i(n),[r,c,l]=i(e),u=m=>Math.max(0,Math.min(255,Math.round(m))),d=u(s+(r-s)*t),h=u(o+(c-o)*t),p=u(a+(l-a)*t);return`rgb(${d},${h},${p})`}class se{constructor(e){this.tileSize=8,this.offsetX=0,this.offsetY=0,this.containerWidth=0,this.containerHeight=0,this.canvas=e;const t=e.getContext("2d");if(!t)throw new Error("Canvas 2D 컨텍스트 생성 실패");this.ctx=t}render(e,t,i){const s=this.ctx,{width:o,height:a}=e.config,r=this.tileSize,c=o*r,l=a*r;this.offsetX=Math.floor((this.containerWidth-c)/2),this.offsetY=Math.floor((this.containerHeight-l)/2),s.fillStyle=f.BG_DARK,s.fillRect(0,0,this.containerWidth,this.containerHeight),this.renderTerrain(e,r),r>=8&&this.renderGrid(e,r),this.renderAgents(t,r,i)}canvasToTile(e,t){const i=this.tileSize,s=Math.floor((e-this.offsetX)/i),o=Math.floor((t-this.offsetY)/i);return e<this.offsetX||t<this.offsetY||s<0||o<0?null:{x:s,y:o}}resize(e,t){this.containerWidth=e,this.containerHeight=t;const i=window.devicePixelRatio||1;this.canvas.width=Math.floor(e*i),this.canvas.height=Math.floor(t*i),this.canvas.style.width=`${e}px`,this.canvas.style.height=`${t}px`,this.ctx.setTransform(i,0,0,i,0,0)}updateTileSize(e,t){const i=Math.min(this.containerWidth/e,this.containerHeight/t);this.tileSize=Math.max(4,Math.min(20,Math.floor(i)))}renderTerrain(e,t){const i=this.ctx,{width:s,height:o}=e.config,a=this.offsetX,r=this.offsetY;for(let c=0;c<o;c++)for(let l=0;l<s;l++){const u=e.tiles[c*s+l];let d;switch(u.terrain){case y.WATER:d=f.TERRAIN_WATER;break;case y.ROCK:d=f.TERRAIN_ROCK;break;case y.PLAIN:default:d=He(f.TERRAIN_PLAIN,f.TERRAIN_PLAIN_LUSH,u.plantDensity);break}i.fillStyle=d,i.fillRect(a+l*t,r+c*t,t,t)}}renderGrid(e,t){const i=this.ctx,{width:s,height:o}=e.config,a=this.offsetX,r=this.offsetY;i.strokeStyle=f.GRID_LINE,i.lineWidth=1;for(let c=0;c<=s;c++)i.beginPath(),i.moveTo(a+c*t+.5,r),i.lineTo(a+c*t+.5,r+o*t),i.stroke();for(let c=0;c<=o;c++)i.beginPath(),i.moveTo(a,r+c*t+.5),i.lineTo(a+s*t,r+c*t+.5),i.stroke()}renderAgents(e,t,i){const s=this.ctx,o=this.offsetX,a=this.offsetY;for(const r of e){if(!r.alive)continue;const c=o+r.pos.x*t+t/2,l=a+r.pos.y*t+t/2,u=r.energy/r.maxEnergy;if(r.type===R.HERBIVORE){const d=t*.35;s.fillStyle=u>.3?f.HERBIVORE:f.HERBIVORE_LOW,s.beginPath(),s.arc(c,l,d,0,Math.PI*2),s.fill()}else{const d=t*.7,h=d*Math.sqrt(3)/2;s.fillStyle=u>.3?f.PREDATOR:f.PREDATOR_LOW,s.beginPath(),s.moveTo(c,l-h/2),s.lineTo(c-d/2,l+h/2),s.lineTo(c+d/2,l+h/2),s.closePath(),s.fill()}if(r.id===i){const d=t*.45;s.strokeStyle=f.ACCENT,s.lineWidth=2,s.beginPath(),s.arc(c,l,d,0,Math.PI*2),s.stroke()}}}}function Me(n){let e=0;for(let t=0;t<n.length;t++){const i=n.charCodeAt(t);e=(e<<5)-e+i,e|=0}return e}function Be(n){if(n.trim()==="")return Date.now();const e=Number(n);return!isNaN(e)&&Number.isFinite(e)?Math.floor(e):Me(n)}const K=[{label:"Map Width",key:"world.width",min:20,max:100,step:5,defaultValue:60},{label:"Map Height",key:"world.height",min:20,max:100,step:5,defaultValue:40},{label:"Water",key:"world.waterRatio",min:0,max:.4,step:.01,defaultValue:.15},{label:"Rock",key:"world.rockRatio",min:0,max:.3,step:.01,defaultValue:.1},{label:"Herbivores",key:"initialHerbivores",min:5,max:200,step:1,defaultValue:40},{label:"Predators",key:"initialPredators",min:1,max:50,step:1,defaultValue:10},{label:"Plant Regrowth",key:"plantRegrowthRate",min:.001,max:.05,step:.001,defaultValue:.01},{label:"Mutation Rate",key:"mutationRate",min:0,max:.5,step:.01,defaultValue:.1}];class De{constructor(e,t){this.sliderInputs=new Map,this.sliderValues=new Map,this.presetButtons=[],this.activePresetIndex=-1,this.destroyed=!1,this.container=e,this.callbacks=t,this.buildUI(),this.updatePreview()}applyPreset(e){const t=e.config;this.setSliderValue("world.width",t.world.width),this.setSliderValue("world.height",t.world.height),this.setSliderValue("world.waterRatio",t.world.waterRatio),this.setSliderValue("world.rockRatio",t.world.rockRatio),this.setSliderValue("initialHerbivores",t.initialHerbivores),this.setSliderValue("initialPredators",t.initialPredators),this.setSliderValue("plantRegrowthRate",t.plantRegrowthRate),this.setSliderValue("mutationRate",t.mutationRate),this.seedInput.value=String(t.seed),this.callbacks.onConfigChange(this.getConfig()),this.updatePreview()}getConfig(){return{world:{width:this.getSliderNum("world.width"),height:this.getSliderNum("world.height"),waterRatio:this.getSliderNum("world.waterRatio"),rockRatio:this.getSliderNum("world.rockRatio")},initialHerbivores:this.getSliderNum("initialHerbivores"),initialPredators:this.getSliderNum("initialPredators"),plantRegrowthRate:this.getSliderNum("plantRegrowthRate"),mutationRate:this.getSliderNum("mutationRate"),seed:Be(this.seedInput.value)}}destroy(){this.destroyed=!0,this.container.innerHTML=""}buildUI(){this.container.innerHTML="",this.container.classList.add("sidebar","sidebar--setup");const e=this.createSection("Presets"),t=document.createElement("div");t.className="preset-chips",k.forEach((r,c)=>{const l=document.createElement("button");l.className="preset-chip",l.textContent=r.name,l.title=r.description,l.addEventListener("click",()=>{this.setActivePreset(c),this.applyPreset(r)}),t.appendChild(l),this.presetButtons.push(l)}),e.appendChild(t),this.container.appendChild(e);const i=this.createSection("Parameters");for(const r of K){const c=this.createSliderRow(r);i.appendChild(c)}this.container.appendChild(i);const s=this.createSection("Seed");this.seedInput=document.createElement("input"),this.seedInput.type="text",this.seedInput.className="text-input",this.seedInput.placeholder="Random (leave empty)",this.seedInput.addEventListener("input",()=>{this.activePresetIndex=-1,this.updatePresetHighlight(),this.callbacks.onConfigChange(this.getConfig()),this.updatePreview()}),s.appendChild(this.seedInput),this.container.appendChild(s);const o=this.createSection("Preview");this.previewContainer=document.createElement("div"),this.previewContainer.style.width="100%",this.previewContainer.style.height="180px",this.previewContainer.style.position="relative",this.previewCanvas=document.createElement("canvas"),this.previewCanvas.style.width="100%",this.previewCanvas.style.height="100%",this.previewContainer.appendChild(this.previewCanvas),o.appendChild(this.previewContainer),this.container.appendChild(o),this.previewRenderer=new se(this.previewCanvas);const a=document.createElement("button");a.className="btn btn--primary",a.textContent="Start Simulation",a.style.width="100%",a.style.marginTop="12px",a.addEventListener("click",()=>{this.callbacks.onStart(this.getConfig())}),this.container.appendChild(a)}createSection(e){const t=document.createElement("div");t.className="panel-section";const i=document.createElement("div");return i.className="panel-section__title",i.textContent=e,t.appendChild(i),t}createSliderRow(e){const t=document.createElement("div");t.className="slider-row";const i=document.createElement("span");i.className="slider-row__label",i.textContent=e.label;const s=document.createElement("input");s.type="range",s.min=String(e.min),s.max=String(e.max),s.step=String(e.step),s.value=String(e.defaultValue);const o=document.createElement("span");return o.className="slider-row__value",o.textContent=this.formatSliderValue(e.defaultValue,e),s.addEventListener("input",()=>{const a=Number(s.value);o.textContent=this.formatSliderValue(a,e),this.activePresetIndex=-1,this.updatePresetHighlight(),this.callbacks.onConfigChange(this.getConfig()),this.updatePreview()}),t.appendChild(i),t.appendChild(s),t.appendChild(o),this.sliderInputs.set(e.key,s),this.sliderValues.set(e.key,o),t}formatSliderValue(e,t){return t.step<.01?e.toFixed(3):t.step<1?e.toFixed(2):String(Math.round(e))}setSliderValue(e,t){const i=this.sliderInputs.get(e),s=this.sliderValues.get(e);if(i&&s){i.value=String(t);const o=K.find(a=>a.key===e);o&&(s.textContent=this.formatSliderValue(t,o))}}getSliderNum(e){const t=this.sliderInputs.get(e);return t?Number(t.value):0}setActivePreset(e){this.activePresetIndex=e,this.updatePresetHighlight()}updatePresetHighlight(){this.presetButtons.forEach((e,t)=>{t===this.activePresetIndex?e.classList.add("preset-chip--active"):e.classList.remove("preset-chip--active")})}updatePreview(){if(this.destroyed)return;const e=this.getConfig(),t=e.world,i=Q(e.seed),s=Z(t,i),o=this.previewContainer.getBoundingClientRect(),a=o.width||280,r=o.height||180;this.previewRenderer.resize(a,r),this.previewRenderer.updateTileSize(t.width,t.height),this.previewRenderer.render(s,[],null)}}const S=40,I=20,Le=10,ke=24,q=500,j=5;class J{constructor(e){this.width=0,this.height=0,this.canvas=e;const t=e.getContext("2d");if(!t)throw new Error("Canvas 2D 컨텍스트 생성 실패");this.ctx=t}renderPopulation(e){const t=[{label:"Plant",color:f.CHART_PLANT,getValue:i=>i.totalPlant},{label:"Herbivore",color:f.CHART_HERBIVORE,getValue:i=>i.herbivoreCount},{label:"Predator",color:f.CHART_PREDATOR,getValue:i=>i.predatorCount}];this.renderChart(e,t)}renderGenes(e){const t=[{label:"Speed",color:f.CHART_SPEED,getValue:i=>i.avgHerbivoreGenes.speed},{label:"Sight",color:f.CHART_SIGHT,getValue:i=>i.avgHerbivoreGenes.sight},{label:"Metab.",color:f.CHART_METABOLISM,getValue:i=>i.avgHerbivoreGenes.metabolism}];this.renderChart(e,t)}resize(e,t){this.width=e,this.height=t;const i=window.devicePixelRatio||1;this.canvas.width=Math.floor(e*i),this.canvas.height=Math.floor(t*i),this.canvas.style.width=`${e}px`,this.canvas.style.height=`${t}px`,this.ctx.setTransform(i,0,0,i,0,0)}renderChart(e,t){const i=this.ctx,s=this.width,o=this.height;if(s===0||o===0)return;i.fillStyle=f.BG_PANEL,i.fillRect(0,0,s,o);const a=e.length>q?e.slice(e.length-q):e;if(a.length===0)return;const r=s-S-Le,c=o-I-ke;if(r<=0||c<=0)return;let l=0;for(const h of a)for(const p of t)l=Math.max(l,p.getValue(h));l=l*1.1,l===0&&(l=1),i.strokeStyle=f.GRID_LINE,i.lineWidth=1,i.font="10px monospace",i.fillStyle=f.TEXT_SECONDARY,i.textAlign="right",i.textBaseline="middle";for(let h=0;h<=j;h++){const p=h/j,m=I+c-p*c,C=p*l;i.beginPath(),i.moveTo(S,m+.5),i.lineTo(S+r,m+.5),i.stroke(),i.fillStyle=f.TEXT_SECONDARY,i.fillText(this.formatYLabel(C),S-4,m)}i.textAlign="center",i.textBaseline="top",i.fillStyle=f.TEXT_SECONDARY;const u=a[0].tick,d=a[a.length-1].tick;i.fillText(String(u),S,I+c+4),i.fillText(String(d),S+r,I+c+4);for(const h of t){i.strokeStyle=h.color,i.lineWidth=1.5,i.beginPath();for(let p=0;p<a.length;p++){const m=S+p/Math.max(a.length-1,1)*r,C=h.getValue(a[p]),g=I+c-C/l*c;p===0?i.moveTo(m,g):i.lineTo(m,g)}i.stroke()}this.renderLegend(t)}renderLegend(e){const t=this.ctx;let i=S;const s=8;t.font="11px sans-serif",t.textAlign="left",t.textBaseline="middle";for(const o of e)t.fillStyle=o.color,t.beginPath(),t.arc(i+4,s,3,0,Math.PI*2),t.fill(),t.fillStyle=f.TEXT_SECONDARY,t.fillText(o.label,i+10,s),i+=t.measureText(o.label).width+22}formatYLabel(e){return e>=1e3?(e/1e3).toFixed(1)+"k":e>=10?Math.round(e).toString():e.toFixed(1)}}function w(n){return Math.round(n).toLocaleString("en-US")}function B(n,e=2){return n.toFixed(e)}class Ve{constructor(e){this.container=e,this.panel=document.createElement("div"),this.panel.className="entity-detail",this.panel.style.display="none",this.container.appendChild(this.panel)}show(e){this.panel.style.display="block",this.panel.innerHTML="";const t=document.createElement("div");t.className="entity-detail__header";const i=document.createElement("span");i.className="entity-detail__type",i.style.color=e.type===R.HERBIVORE?f.HERBIVORE:f.PREDATOR,i.textContent=e.type===R.HERBIVORE?"Herbivore":"Predator";const s=document.createElement("span");s.className="entity-detail__id",s.textContent=`#${e.id}`,t.appendChild(i),t.appendChild(s),this.panel.appendChild(t);const o=e.energy/e.maxEnergy;this.addStat("Energy",`${B(e.energy,1)} / ${B(e.maxEnergy,1)}`),this.addEnergyBar(o),this.addStat("Age",`${e.age} ticks`),this.addStat("Generation",`${e.generation}`),this.addStat("Children",`${e.childrenCount}`),this.addStat("Position",`(${e.pos.x}, ${e.pos.y})`);const a=document.createElement("div");a.className="panel-section__title",a.textContent="Genes",a.style.marginTop="8px",this.panel.appendChild(a),this.addGeneBar("Speed",e.genes.speed,f.CHART_SPEED),this.addGeneBar("Sight",e.genes.sight,f.CHART_SIGHT),this.addGeneBar("Metabolism",e.genes.metabolism,f.CHART_METABOLISM)}hide(){this.panel.style.display="none"}addStat(e,t){const i=document.createElement("div");i.className="entity-detail__stat";const s=document.createElement("span");s.className="entity-detail__stat-label",s.textContent=e;const o=document.createElement("span");o.className="entity-detail__stat-value",o.textContent=t,i.appendChild(s),i.appendChild(o),this.panel.appendChild(i)}addEnergyBar(e){const t=document.createElement("div");t.className="energy-bar";const i=document.createElement("div"),s=Math.max(0,Math.min(1,e));i.style.width=`${s*100}%`;let o="energy-bar__fill";e<=.3?o+=" energy-bar__fill--low":e<=.7?o+=" energy-bar__fill--mid":o+=" energy-bar__fill--high",i.className=o,t.appendChild(i),this.panel.appendChild(t)}addGeneBar(e,t,i){const s=document.createElement("div");s.className="gene-bar";const o=document.createElement("span");o.className="gene-bar__label",o.textContent=e;const a=document.createElement("div");a.className="gene-bar__track";const r=document.createElement("div");r.className="gene-bar__fill",r.style.background=i;const c=Math.max(0,Math.min(1,(t-.1)/(2-.1)));r.style.width=`${c*100}%`,a.appendChild(r);const l=document.createElement("span");l.className="gene-bar__value",l.textContent=B(t,2),s.appendChild(o),s.appendChild(a),s.appendChild(l),this.panel.appendChild(s)}}class Ge{constructor(e,t){this.speedButtons=[],this.currentSpeed=1,this.isPaused=!1,this.selectedEntityId=null,this.resizeObserver=null,this.destroyed=!1,this.container=e,this.callbacks=t,this.buildUI(),this.setupResizeObserver()}update(e){if(this.destroyed)return;this.tickCounter.textContent=`Tick: ${w(e.tick)}`,this.worldRenderer.updateTileSize(e.world.config.width,e.world.config.height),this.worldRenderer.render(e.world,e.agents,this.selectedEntityId),this.popChartRenderer.renderPopulation(e.history),this.geneChartRenderer.renderGenes(e.history);const t=e.history.length>0?e.history[e.history.length-1]:null;if(t&&(this.herbivoreCountEl.textContent=w(t.herbivoreCount),this.predatorCountEl.textContent=w(t.predatorCount),this.plantCountEl.textContent=w(Math.round(t.totalPlant))),this.selectedEntityId!==null){const i=e.agents.find(s=>s.id===this.selectedEntityId&&s.alive);i?this.entityDetail.show(i):(this.selectedEntityId=null,this.entityDetail.hide())}}setSelectedEntity(e){this.selectedEntityId=e,e===null&&this.entityDetail.hide()}getSelectedEntityId(){return this.selectedEntityId}getWorldRenderer(){return this.worldRenderer}destroy(){this.destroyed=!0,this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.container.innerHTML=""}buildUI(){this.container.innerHTML="",this.headerEl=document.createElement("div"),this.headerEl.className="header",this.buildHeader(),this.container.appendChild(this.headerEl),this.layoutEl=document.createElement("div"),this.layoutEl.className="layout-simulation",this.canvasContainer=document.createElement("div"),this.canvasContainer.className="canvas-container",this.worldCanvas=document.createElement("canvas"),this.worldCanvas.addEventListener("click",e=>this.handleCanvasClick(e)),this.canvasContainer.appendChild(this.worldCanvas),this.worldRenderer=new se(this.worldCanvas),this.layoutEl.appendChild(this.canvasContainer),this.sidebarEl=document.createElement("div"),this.sidebarEl.className="sidebar",this.buildSidebar(),this.layoutEl.appendChild(this.sidebarEl),this.container.appendChild(this.layoutEl)}buildHeader(){const e=document.createElement("span");e.className="header__title",e.textContent="Ecosystem Sim",this.headerEl.appendChild(e),this.tickCounter=document.createElement("span"),this.tickCounter.className="header__tick",this.tickCounter.textContent="Tick: 0",this.headerEl.appendChild(this.tickCounter);const t=document.createElement("div");t.className="header__spacer",this.headerEl.appendChild(t);const i=document.createElement("div");i.className="speed-group";const s=[1,2,5,10];for(const c of s){const l=document.createElement("button");l.className=c===1?"speed-btn speed-btn--active":"speed-btn",l.textContent=`${c}x`,l.addEventListener("click",()=>{this.currentSpeed=c,this.updateSpeedButtons(),this.callbacks.onSpeedChange(c)}),i.appendChild(l),this.speedButtons.push(l)}this.headerEl.appendChild(i);const o=document.createElement("div");o.className="header__controls",this.pauseBtn=document.createElement("button"),this.pauseBtn.className="btn btn--small",this.pauseBtn.textContent="Pause",this.pauseBtn.addEventListener("click",()=>{this.isPaused?(this.isPaused=!1,this.pauseBtn.textContent="Pause",this.callbacks.onResume()):(this.isPaused=!0,this.pauseBtn.textContent="Resume",this.callbacks.onPause())}),o.appendChild(this.pauseBtn);const a=document.createElement("button");a.className="btn btn--small",a.textContent="Step",a.addEventListener("click",()=>{this.callbacks.onStep()}),o.appendChild(a);const r=document.createElement("button");r.className="btn btn--small",r.textContent="Restart",r.addEventListener("click",()=>{this.callbacks.onRestart()}),o.appendChild(r),this.headerEl.appendChild(o)}buildSidebar(){const e=this.createSection("Population"),t=document.createElement("div");t.className="population-stats";const i=this.createStatItem(f.CHART_PLANT,"0");this.plantCountEl=i.querySelector(".population-stats__value"),t.appendChild(i);const s=this.createStatItem(f.CHART_HERBIVORE,"0");this.herbivoreCountEl=s.querySelector(".population-stats__value"),t.appendChild(s);const o=this.createStatItem(f.CHART_PREDATOR,"0");this.predatorCountEl=o.querySelector(".population-stats__value"),t.appendChild(o),e.appendChild(t),this.sidebarEl.appendChild(e);const a=this.createSection("Population Chart");this.popChartCanvas=document.createElement("canvas"),this.popChartCanvas.style.width="100%",this.popChartCanvas.style.height="200px",a.appendChild(this.popChartCanvas),this.popChartRenderer=new J(this.popChartCanvas),this.sidebarEl.appendChild(a);const r=this.createSection("Gene Trends");this.geneChartCanvas=document.createElement("canvas"),this.geneChartCanvas.style.width="100%",this.geneChartCanvas.style.height="200px",r.appendChild(this.geneChartCanvas),this.geneChartRenderer=new J(this.geneChartCanvas),this.sidebarEl.appendChild(r);const c=this.createSection("Selected Entity");this.entityDetail=new Ve(c),this.sidebarEl.appendChild(c)}createSection(e){const t=document.createElement("div");t.className="panel-section";const i=document.createElement("div");return i.className="panel-section__title",i.textContent=e,t.appendChild(i),t}createStatItem(e,t){const i=document.createElement("div");i.className="population-stats__item";const s=document.createElement("span");s.className="population-stats__dot",s.style.background=e;const o=document.createElement("span");return o.className="population-stats__value",o.textContent=t,i.appendChild(s),i.appendChild(o),i}updateSpeedButtons(){const e=[1,2,5,10];this.speedButtons.forEach((t,i)=>{e[i]===this.currentSpeed?t.className="speed-btn speed-btn--active":t.className="speed-btn"})}handleCanvasClick(e){const t=this.worldCanvas.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top,o=this.worldRenderer.canvasToTile(i,s);o&&this.callbacks.onEntityClick(o)}setupResizeObserver(){this.resizeObserver=new ResizeObserver(()=>{this.destroyed||this.resizeCanvases()}),requestAnimationFrame(()=>{this.destroyed||(this.canvasContainer&&this.resizeObserver?.observe(this.canvasContainer),this.sidebarEl&&this.resizeObserver?.observe(this.sidebarEl),this.resizeCanvases())})}resizeCanvases(){if(this.destroyed)return;const e=this.canvasContainer.getBoundingClientRect(),t=e.width-16,i=e.height-16;t>0&&i>0&&this.worldRenderer.resize(t,i);const o=this.sidebarEl.getBoundingClientRect().width-24;o>0&&(this.popChartRenderer.resize(o,200),this.geneChartRenderer.resize(o,200))}}function We(n){let e=0;for(let t=0;t<n.length;t++){const i=n.charCodeAt(t);e=(e<<5)-e+i,e|=0}return e}function ze(){const n=new URLSearchParams(window.location.search),e=n.get("seed"),t=n.get("preset");let i=null;if(e!==null){const s=Number(e);i=!isNaN(s)&&Number.isFinite(s)?Math.floor(s):We(e)}return{seed:i,preset:t}}class Ye{constructor(e){this.state="setup",this.simState=null,this.prng=null,this.setupPanel=null,this.simulationPanel=null,this.animFrameId=0,this.root=e}start(){const e=ze();this.showSetup(e)}showSetup(e){this.state="setup",this.cleanupSimulation(),this.root.innerHTML="";const t=document.createElement("div");t.className="layout-setup",t.style.flex="1";const i=document.createElement("div"),s=document.createElement("div");if(s.className="canvas-container",s.innerHTML='<div style="color:var(--text-secondary);font-size:13px;">Adjust parameters and click "Start Simulation"</div>',t.appendChild(i),t.appendChild(s),this.root.appendChild(t),this.setupPanel=new De(i,{onConfigChange:o=>{},onStart:o=>{this.startSimulation(o)}}),e){if(e.preset){const o=e.preset.toLowerCase(),a=k.find(r=>r.name.toLowerCase()===o);if(a)if(e.seed!==null){const r={...a,config:{...a.config,seed:e.seed}};this.setupPanel.applyPreset(r)}else this.setupPanel.applyPreset(a)}else if(e.seed!==null){const o=k[0],a={...o,config:{...o.config,seed:e.seed}};this.setupPanel.applyPreset(a)}}}startSimulation(e){this.state="running",this.setupPanel&&(this.setupPanel.destroy(),this.setupPanel=null),this.root.innerHTML="";const t=Oe(e);this.simState=t.state,this.prng=t.prng,this.simState.running=!0,this.simState.speed=1,this.simulationPanel=new Ge(this.root,{onPause:()=>{this.state="paused",this.simState&&(this.simState.running=!1)},onResume:()=>{this.state="running",this.simState&&(this.simState.running=!0)},onStep:()=>{this.simState&&this.prng&&X(this.simState,this.prng)},onSpeedChange:i=>{this.simState&&(this.simState.speed=i)},onRestart:()=>{this.showSetup()},onEntityClick:i=>{this.handleEntityClick(i)}}),this.startGameLoop()}startGameLoop(){let t=0,i=0;const s=o=>{if(!(!this.simState||!this.prng||!this.simulationPanel)){if(t>0&&(i+=o-t),t=o,this.state==="running"&&this.simState.running){const a=55/this.simState.speed,r=a*10;for(i>r&&(i=r);i>=a;)X(this.simState,this.prng),i-=a}else i=0;this.simulationPanel.update(this.simState),this.animFrameId=requestAnimationFrame(s)}};this.animFrameId=requestAnimationFrame(s)}handleEntityClick(e){if(!this.simState||!this.simulationPanel)return;const t=this.simulationPanel.getSelectedEntityId();let i=null;for(const s of this.simState.agents){if(!s.alive)continue;const o=s.pos.x-e.x,a=s.pos.y-e.y,r=Math.abs(o)+Math.abs(a);r<=2&&(!i||r<i.dist)&&(i={id:s.id,dist:r})}i?t===i.id?this.simulationPanel.setSelectedEntity(null):this.simulationPanel.setSelectedEntity(i.id):this.simulationPanel.setSelectedEntity(null)}cleanupSimulation(){this.animFrameId&&(cancelAnimationFrame(this.animFrameId),this.animFrameId=0),this.simulationPanel&&(this.simulationPanel.destroy(),this.simulationPanel=null),this.simState=null,this.prng=null}}const Fe=document.getElementById("app"),$e=new Ye(Fe);$e.start();
